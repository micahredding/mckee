<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="apple-touch-icon" href="apple-touch-icon.png">
        <!-- Place favicon.ico in the root directory -->

        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/main.css">
        <link rel="stylesheet" href="css/application.css">
        <script src="js/vendor/modernizr-2.8.3.min.js"></script>
    </head>
    <body>
        <p>Hello world! This is HTML5 Boilerplate.</p>

        <div ng-app="mapsApp" ng-controller="mapCtrl">
            <script type="text/ng-template" id="control.tpl.html">
                <button class="btn btn-sm btn-primary" ng-click="controlClick()">{{controlText}}</button>
            </script>
            <ui-gmap-google-map center='map.center' zoom='map.zoom'>
                <ui-gmap-markers models="markers" coords="'self'" icon="'icon'">

                <ui-gmap-drawing-manager options="drawingManagerOptions" control="drawingManagerControl"></ui-gmap-drawing-manager>

                <ui-gmap-map-control template="control.tpl.html" position="top-right" controller="controlTerritories" index="-1"></ui-gmap-map-control>
                <ui-gmap-map-control template="control.tpl.html" position="top-right" controller="controlMarkers" index="-1"></ui-gmap-map-control>
            </ui-gmap-google-map>
        </div>

        <script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.12.0.min.js"><\/script>')</script>
        <script src='js/vendor/lodash.min.js'></script>
        <script src='js/vendor/angular.min.js'></script>
        <script src='js/vendor/angular-simple-logger.min.js'></script>
        <script src='js/vendor/angular-google-maps.min.js'></script>
        <script src='http://maps.googleapis.com/maps/api/js?key=AIzaSyDJD7CqecceAf1iIlFuvQc5mQz0HDJWX1E&libraries=drawing'></script>
        <script>

            var app = angular.module('mapsApp', ['uiGmapgoogle-maps']);

            app.service("PolygonService", function () {
                var polygons = [];
                this.pushPolygon = function(polygon){
                    polygons.push(polygon);
                }
                this.getPolygons = function(){
                    return polygons;
                }
                this.clearPolygons = function(){
                    angular.forEach(polygons, function(polygon){
                        polygon.setMap(null);
                    });
                    polygons = [];
                }
            });

            app.service("MarkerService", function () {
                var visibleMarkers = true;
                var cities = [
                    {
                        id : 1,
                        city : 'Toronto',
                        desc : 'This is the best city in the world!',
                        latitude : 43.7000,
                        longitude : -79.4000
                    },
                    {
                        id : 2,
                        city : 'New York',
                        desc : 'This city is aiiiiite!',
                        latitude : 40.6700,
                        longitude : -73.9400
                    },
                    {
                        id : 3,
                        city : 'Chicago',
                        desc : 'This is the second best city in the world!',
                        latitude : 41.8819,
                        longitude : -87.6278
                    },
                    {
                        id : 4,
                        city : 'Los Angeles',
                        desc : 'This city is live!',
                        latitude : 34.0500,
                        longitude : -118.2500
                    },
                    {
                        id : 5,
                        city : 'Las Vegas',
                        desc : 'Sin City...\'nuff said!',
                        latitude : 36.0800,
                        longitude : -115.1522
                    }
                ];
                this.markers = function() {
                    return cities;
                }
                this.visible = function() {
                    return visibleMarkers;
                }
                this.toggleMarkers = function() {
                    visibleMarkers = !visibleMarkers;
                }
            });

            app.controller('mapCtrl', function($scope, MarkerService, PolygonService, uiGmapIsReady) {
                $scope.map = { center: { latitude: 45, longitude: -73 }, zoom: 3 };

                // $scope.drawingManager = new google.maps.drawing.DrawingManager({
                //     drawingMode: google.maps.drawing.OverlayType.POLYGON,
                //     drawingControl: false,
                //     drawingControlOptions: {
                //         position: google.maps.ControlPosition.TOP_CENTER,
                //         drawingModes: [google.maps.drawing.OverlayType.POLYGON]
                //     },
                // });

                // google.maps.event.addListener($scope.drawingManager, 'polygoncomplete', function (polygon) {
                //     PolygonService.pushPolygon(polygon);
                // });

                // uiGmapIsReady.promise(1).then(function(instances) {
                //     instances.forEach(function(inst) {
                //         var map = inst.map;
                //         $scope.drawingManager.setMap(map);
                //     });
                // });

                $scope.drawingManagerOptions = {
                    drawingMode: google.maps.drawing.OverlayType.POLYGON,
                    drawingControl: true,
                    drawingControlOptions: {
                      position: google.maps.ControlPosition.TOP_CENTER,
                        drawingModes: [
                          google.maps.drawing.OverlayType.POLYGON
                        ]
                    },
                };
                $scope.drawingManagerControl = {};

                uiGmapIsReady.promise(1).then(function(instances) {
                    instances.forEach(function(inst) {
                        var map = inst.map;
                        var drawingManager = $scope.drawingManagerControl.getDrawingManager();
                        google.maps.event.addListener(drawingManager, 'polygoncomplete', function (polygon) {
                            PolygonService.pushPolygon(polygon);
                        });
                    });
                });

                $scope.$watch(function() { return MarkerService.visible(); },
                    function(newValue, oldValue) {
                        if(newValue) {
                            $scope.markers = MarkerService.markers();
                        } else {
                            $scope.markers = [];
                        }
                    }
                );
            });

            app.controller('controlMarkers', function ($scope, MarkerService) {
                $scope.controlText = 'Hide Markers';
                $scope.controlClick = function () {
                    return MarkerService.toggleMarkers();
                };
            });

            app.controller('controlTerritories', function ($scope, MarkerService, PolygonService) {
                $scope.controlText = 'Clear Territories';
                $scope.controlClick = function (event) {
                    return PolygonService.clearPolygons();
                };
            })

        </script>
    </body>
</html>
